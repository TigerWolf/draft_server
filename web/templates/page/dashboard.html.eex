<html>
<head>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.0.0-beta1/jquery.js"></script>
  <!-- Compiled and minified CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.5/css/materialize.min.css">

  <!-- Compiled and minified JavaScript -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.5/js/materialize.min.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.5/handlebars.js"></script>

  <style>

    /*body{
      margin: 0;
      padding: 0;
      font-size: 10px;
    }*/

/*
    .draft_box{
      background: #e5e5e5;
      box-shadow: 3px 4px 8px 0 #2e4300;
      margin-top: 20px;
      margin-bottom: 20px;
      display: inline-block;
    }

    .draft_box .details{
      display: inline-block;
      width: 100px;
      vertical-align: top;
    }

    .player_name{
      text-overflow: ellipsis;
      font-weight: bold;
      overflow: hidden;
      white-space: nowrap;
    }

    .draft_box .position {
      font-size: 14px;
      margin: 5px;
    }

    .draft_box .name{
      margin: 5px;
      padding: 5px;
      border: 1px solid;
      font-weight: bold;
      display: inline-block;
    }
*/

    /*.card{
      display:inline-block;
    }

    .card .card-image .card-title{
      font-size: 10px;
      color: red;
    }

    .card.small{
      width:100%;
      height: 100px;
    }*/



  /* MARK */
    .player-card{
      font-size: 10px;
      border: 1px solid;
      margin: 5px;
      position: relative;
      width:100%;
      height: 30px;
      transition: box-shadow .25s;
      border-radius: 2px;
    }

    .player-card .image{
      float:left;
      width: 29%;
      height: 100%;
      background-size: contain;
      background-position: center top;
      background-repeat: no-repeat;
    }

    .player-card .info{
      float:left;
      width: 70%;
    }

    .clear-both {
      clear: both;
    }

  </style>
  <script type="text/javascript">
  "use strict";

  class Player {
    constructor(id, name, image, position) {
      this.id = id;
      this.name = name;
      this.image = image;
    }
  }

  class User {
    constructor(id, name, image) {
      this.id = id;
      this.name = name;
      this.image = image;
    }
  }

  var players = [];
  var users = [];
  var tld = "http://direct.challengecup.club:8080/api/v1/"
  // var tld = "http://localhost:4000/api/v1/"
  // var tld = "//api/v1/"

  $(function() {
    startRefresh();
  });

  function startRefresh() {
    /*setTimeout(startRefresh,10000);*/
    startLoad();
  }

  function startLoad() {
    players = []
    users = []
    $.getJSON( tld + "drafts/players", function( data ) {
      $.each( data["lists"], function( key, val ) {
        players.push(new Player(val["player"]["playerId"], val["player"]["givenName"] + " " + val["player"]["surname"], val["player"]["photoURL"]));
      });

      getUsers();
      getDrafted();
    });

  };

  function getUsers(){
    $.getJSON( tld + "the_users", function( data ) {
      $.each( data["data"], function( key, val ) {
        users.push(new User(val.id, val.email));
      });

      $('.content .row').html("");
      for (var i = 0; i < users.length; i++) {
        var user = users[i];
        var size = Math.round(12/users.length);
        if (users.length > 12) {
          size = 1;
        }
        $('.content .row').append('<div class="col s'+size+' player-'+user.id+'"><span class="player_name">'+ user.name +'</span></div>');
      }

    });
  };

  function getDrafted(){
    $.getJSON( tld + "drafts", function( data ) {
      var items = [];
      $.each( data["data"], function( key, val ) {
        var found_player = new Player()
        for (var i = 0; i < players.length; i++) {
          var player = players[i];
          if (player.id == val.player_id){
            found_player = player
          }
        }

        var found_user = new User();
        for (var i = 0; i < users.length; i++) {
          var user = users[i]
          if (user.id == val.user_id){
            found_user = user
          }
        }

        var source   = $("#card-template").html();
        var template = Handlebars.compile(source);
        var context = {image: found_player.image, player_name: found_player.name, user: found_user.name, position: val.position};
        var html    = template(context);
        $('.content .row .player-' + found_user.id).append(html);
      });

    });
  };
  </script>

</head>
<body>
  <div class="content">
    <div class="row">
   </div>
  </div>
</body>
</html>

<script id="card-template" type="text/x-handelbars-template">
  <div class="player-card">
    <div class="image" style="background-image:url('{{image}}');">
      &nbsp;
    </div>
    <div class="info">
      <div class="player_name">{{player_name}}</div>
      <div class="position">{{position}}</div>
    </div>
    <div class="clear-both"></div>
  </div>
</script>
